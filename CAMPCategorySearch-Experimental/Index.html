<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Database Tool for Fallout 76 C.A.M.P. Items. Lists Workshop Menu categories, Plan/Entitlement requirements, C.A.M.P. budget costs, and allows searches.">
  <meta property="og:title" content="Fallout 76 C.A.M.P. Item Database">
  <meta property="og:description" content="Database Tool for Fallout 76 C.A.M.P. Items. Lists Workshop Menu categories, Plan/Entitlement requirements, C.A.M.P. budget costs, and allows searches.">
  <meta property="og:image" content="https://raw.githubusercontent.com/MrsBlobby/mrsblobby.github.io/refs/heads/main/assets/CAMPIcon2.webp">
  <meta property="og:url" content="https://yourdomain.com/">
  <meta property="og:type" content="website">
  <link rel="icon" type="image/webp" sizes="32x32" href="/assets/CAMPIcon2.webp">
  <link rel="icon" type="image/webp" sizes="16x16" href="/assets/CAMPIcon2.webp">
  <title>Fallout 76 C.A.M.P. Item Database</title>
 <style>
  :root {
    --accent: #ffc00f;
    --accent-dim: #ffb300;
    --bg: #1a1a1a;
    --card-bg: #2a2a2a;
    --text: #e0e0e0;
    --text-muted: #aaa;
    --content-width: 800px;
    --card-width: 720px;
  }

  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background-color: var(--bg);
    color: var(--text);
  }

  .container {
    max-width: var(--content-width);
    margin: 0 auto;
    padding: 0 16px;
  }

  h1 {
    color: var(--accent);
    margin-bottom: 5px;
    text-align: center;
  }

 .meta {
    text-align: center;
    margin-top: 0.5em;
  }

  .author {
    color: var(--text-muted);
    font-size: 14px;
  }

  .badge-link {
    background: #333;
    color: var(--accent);
    border-radius: 4px;
    padding: 2px 6px;
    margin-left: 6px;
    text-decoration: none;
    font-size: 12px;
    transition: background 0.2s;
  }

  .badge-link:hover {
    background: #555;
  }

  .updated {
    color: var(--text-muted);
    font-size: 12px;
    margin-top: 4px;
  }

  #pagination button {
    padding: 6px 10px;
    margin-left: 2px;
    margin-left: 2px;
    background: var(--card-bg);
    color: var(--text);
    border: 2px solid var(--accent);
    border-radius: 4px;
    cursor: pointer;
    transition: 0.2s;
  }
  #pagination button:hover:not(:disabled) {
    background: var(--accent);
    color: black;
  }
  #pagination button:disabled {
    opacity: 0.4;
    cursor: default;
  }

  .controls {
    position: flex;
    top: 0;
    z-index: 100;
    background: var(--bg);
    padding: 12px 16px;
    border-bottom: 1px solid var(--card-bg);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }

  .controls input[type="text"] {
    padding: 10px;
    font-size: 16px;
    width: 100%;
    max-width: 350px;
    border: 2px solid var(--accent);
    border-radius: 6px;
    background-color: var(--card-bg);
    color: var(--text);
  }

  .controls .search-line {
    display: flex;
    gap: 0;
    width: 100%;
    max-width: 450px;
  }

  .search-line input:focus,
  .search-line select:focus,
  .search-line textarea:focus {
    outline: none;
    box-shadow: none;
  }

  .search-line input {
    -webkit-appearance: none;
  }

  .search-line {
    display: flex;
    gap: 0;
    width: 100%;
    max-width: 450px;
    align-items: center; 
  }

  .controls label {
    font-size: 14px;
    color: var(--text-muted);
    margin-left: 4px;
  }

  .controls .inline-group {
    display: flex;
    align-items: center;
    gap: -10px;
    justify-content: center;
    margin-top: 8px;
  }

  .inline-group {
    display: flex;
    align-items: center;
    gap: 0px;
    justify-content: center;
    margin-top: 8px;
    width: 100%;
  }

  #clearFiltersExternal {
    background-color: var(--card-bg)
    color: var(--dropdown-text, #fff);
    border: 2px solid var(--accent);
    border-left: none;
    position: relative;
    top: -4px;
    border-radius: 0 6px 6px 0;
    height: 36px;
    padding: 0 12px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .inline-group label {
    font-size: 14px;
    color: var(--text-muted);
  }

  .group-filters {
    display: flex;
    margin-right: 30px;
    flex-shrink: 0;
  }

  .group-sort {
    display: flex;
    align-items: center;
    gap: 8px; 
  }

  ul {
    list-style-type: none;
    padding: 16px;
    margin: 0 auto;
    max-width: 600px;
  }

  li {
    display: flex;
    align-items: center;
    gap: 0px;
    padding: 12px;
    background-color: var(--card-bg);
    box-sizing: border-box;
    margin-bottom: 14px;
    border-radius: 6px;
    border: 2px solid var(--accent);
    box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    width: 100%;
  }

  .result-left {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-shrink: 0;
    width: 220px;
  }

  .result-name {
    font-weight: bold;
    font-size: 18px;
    color: var(--accent);
    margin-bottom: 6px;
    max-width: 220px;
    text-align: center;
  }

  .result-left img {
    border-radius: 6px;
    max-width: 128px;
    height: auto;
    object-fit: contain;
    display: block;
  }

  .result-right {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    text-align: center;
    width: 100%;
    justify-content: center;
  }

  .result-right .section-header {
    font-weight: 700;
    font-size: 14px;
    color: var(--accent);
    text-align: center;
    margin: 4px 0;
  }

  .result-right span.pill {
    background: var(--bg);
    border: 2px solid var(--accent);
    border-radius: 20px;
    padding: 3px 10px;
    font-size: 14px;
    color: var(--accent);
    font-weight: normal;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-align: center;
  }

  .inline-wrap {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    flex-wrap: wrap;
  }

  .connector {
    color: var(--accent);
    font-weight: 600;
    font-size: 13px;
    margin: 0 6px;
    line-height: 1;
  }

  .arrow {
    display: inline-block;
    width: 0;
    height: 0;
    border-top: 6px solid transparent;
    border-bottom: 6px solid transparent;
    border-left: 10px solid var(--accent);
    margin: 0 8px;
    vertical-align: middle;
  }

  .inline-wrap .arrow + .arrow {
    display: none;
  }

  .pill {
    background: var(--bg);
    border: 2px solid var(--accent);
    border-radius: 20px;
    padding: 4px 12px;
    font-size: 14px;
    color: var(--accent);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    line-height: 1.2;
    max-width: 240px;
    min-height: 30px;
    word-break: break-word;
  }

  details {
    margin: 10px 0 20px 0;
    font-size: 12px;
    color: var(--text-muted);
  }

  details summary {
    cursor: pointer;
    font-weight: bold;
    color: var(--accent);
    text-align: center;
    max-width: 200px;
    margin: 0 auto;           
    padding: 2px 6px;
  }

  .changelog-entry h4 {
      margin: 0 0 4px 0;
      font-size: 14px;
      font-weight: bold;
      color: var(--accent);
    }

    .changelog-entry {
      background: rgba(255, 192, 15, 0.05);
      border-left: 3px solid var(--accent);
      border-radius: 4px;
      padding: 6px 12px;
      margin: 6px 0;
      text-align: left;
    }

  #searchBox {
    flex: 1;
    height: 40px;
    font-size: 16px;
    padding: 0 12px;
    border: 2px solid var(--accent);
    border-right: none;
    border-radius: 6px 0 0 6px;
    background-color: var(--card-bg);
    color: var(--text);
    box-sizing: border-box;
  }

    #searchBox, #dropdownSelected {
      width: 100%;
      border-right: none; 
    }

  #dropdownOptions {
    position: absolute;
    font-size: 14px;
    top: 100%;
    left: 0;
    width: 100%;
    margin-top: -2px;
    background-color: var(--card-bg);
    border: 2px solid var(--accent);
    box-sizing: border-box;
    border-radius: 0 0 6px 6px;
    z-index: 200;
  }

  #dropdownOptions .option {
    padding: 8px 12px;
    cursor: pointer;
  }

  #dropdownOptions .option:hover {
    background-color: var(--accent);
    color: black;
  }

  #dropdownOptions,
  #filtersOptions,
  #sortOptions {
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    margin-top: -2px;
    background-color: var(--card-bg);
    border: 2px solid var(--accent);
    border-radius: 0 0 6px 6px;
    box-sizing: border-box;
    z-index: 200;

    /* animation setup */
    opacity: 0;
    transform: scaleY(0.95);
    max-height: 0;
    pointer-events: none;
    transition: opacity 0.15s ease, transform 0.15s ease, max-height 0.2s ease;
  }

  #dropdownOptions.open,
  #filtersOptions.open,
  #sortOptions.open {
    opacity: 1;
    transform: scaleY(1);
    max-height: 500px; /* adjust to fit content */
    pointer-events: auto;
  }


  #dropdownSelected {
    display: flex;
    align-items: center;
    padding: 0 12px;
    font-size: 14px;
    border: 2px solid var(--accent);
    border-left: 2px solid var(--accent);
    border-radius: 0 6px 6px 0;
    background-color: var(--card-bg);
    color: var(--text);
    cursor: pointer;
    box-sizing: border-box;
  }

  #dropdownSelected.open {
    border-radius: 0 6px 0 0; /* bottom-right sharp when dropdown is open */
  }

  .custom-dropdown {
    position: relative;
    width: max-content;
    height: 40px;
    display: flex;
    flex-shrink: 0;
  }

  #sortDropdown, #sortSelected, #sortOptions,
  .custom-dropdown, #dropdownSelected, #dropdownOptions {
    box-sizing: border-box;
  }

  #filtersButton,
  #sortSelected {
    height: 36px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px; /* keeps space between text and icon if any */
    padding: 0 12px;
    font-size: 14px;
    line-height: 1;
    border: 2px solid var(--accent);
    border-radius: 6px;
    background-color: var(--card-bg);
    color: var(--text);
    cursor: pointer;
    box-sizing: border-box;
    vertical-align: middle;
  }

  #filtersDropdown,
  #sortDropdown {
    display: inline-flex;
    position: relative;
    align-items: center;
    margin: 0;
    padding: 0;
  }


  #filtersDropdown, #sortDropdown {
    margin: 0;
    padding: 0;
  }

  #filtersDropdown {
    width: 150px;   
    position: relative;
    border-radius: 6px 0 0 6px;
  }

  #filtersButton {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    padding: 0 12px;
    font-size: 14px;
    width: 100%;
    border: 2px solid var(--accent); /* keep border if you like */
    border-radius: 6px 0 0 6px;
    background-color: var(--card-bg);
    color: var(--text);
    cursor: pointer;
    box-sizing: border-box;
    height: 36px;
    transition: background-color 0.15s, color 0.15s;
  }

  #filtersButton.active {
    background-color: var(--accent);
    color: var(--bg); 
    border-color: var(--accent);
    box-shadow: none;
  }


  #filtersButton.active .filters-label {
    color: var(--bg-color); 
    font-weight: bold;
  }


  #filtersButton .filter-icon {
    width: 20px;  
    height: 20px;
    flex-shrink: 0;
    vertical-align: middle;
  }

  .filter-columns {
    display: flex;
    flex-direction: column;
    gap: 8px; 
    padding: 4px 0;
  }

  .filter-columns > div {
    flex: 1;
  }

  .filter-header {
    font-weight: bold;
    font-size: 15px;
    text-align: center;
    background-color: rgba(255, 192, 15, 0.1);
    color: var(--accent);
    padding: 4px 0;
    margin: 0;
    border-radius: 4px 4px 0 0;
  }

  #filtersOptions button {
    padding: 6px 10px;
    border: 1px solid var(--accent);
    border-radius: 4px;
    background: var(--card-bg);
    cursor: pointer;
  }

  #filtersOptions button[data-filter] {
    display: block;
    width: 100%;
    padding: 2px;
    margin: 0;
    margin-top: -4px;
    margin-bottom: -2px;
    text-align: center;   
    background: var(--card-bg);
    border: none;
    color: var(--text);
    font-size: 13px;
    line-height: 1.3;
    cursor: pointer;
    border-radius: 0;
  }

  #filtersOptions button[data-filter].selected {
    background-color: var(--accent);
    color: var(--bg); 
  }

  #filtersOptions button[data-filter]:hover {
    background-color: var(--accent-dim);
    color: var(--bg); 
  }

  .filter-header {
    font-weight: bold;
    font-size: 13px;
    text-align: center;
    background-color: rgba(255, 192, 15, 0.1); 
    color: var(--accent);
    padding: 2px 0;          
    margin: 0;
    border-radius: 0; 
  }

  #filtersOptions button[data-filter]:hover,
  #filtersOptions button[data-filter].selected {
    background-color: var(--accent);     
    color: black;                        
  }

  #filtersButton.open {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
  }

  .clear-filters {
    margin-top: 4px;              
    padding: 4px 8px;             
    background-color: #ffeded;
    border: 1px solid #ff4d4f;
    color: #ff4d4f;        
    border-radius: 4px 4px 0 0;    
    cursor: pointer;
    text-align: center;
    font-size: 13px;
    transition: background 0.15s, transform 0.1s, color 0.15s;
  }

  .clear-filters:hover {
    background-color: #ffb3b3;
    color: #ff4d4f;         
  }

  .clear-filters:active {
    background-color: #ff9999; 
    color: #ff4d4f;         
  }


  #filtersOptions {
    display: flex;
    flex-direction: column;
    gap: 0;                 
    padding: 0;
    margin-top: -2px;
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    background-color: var(--card-bg);
    border: 2px solid var(--accent);
    border-top: none;
    border-radius: 0 0 6px 6px; 
    box-sizing: border-box;
    z-index: 200;
  }

  #filtersOptions .option {
    padding: 8px 12px;
    cursor: pointer;
  }

  #filtersOptions .option:hover {
    background: var(--accent-dim);
    color: black;
  }

  .clear-filters {
    margin-top: 8px;
    background-color: #ffeded;
    border: 1px solid #ff4d4f;
    color: #ff4d4f;
    border-radius: 4px;
    padding: 4px 8px;
    cursor: pointer;
  }

  #sortSelected,
  #sortOptions,
  #filtersButton,
  #filtersOptions {
    width: 100%;
    box-sizing: border-box;
  }

  #sortDropdown {
    position: relative;
    width: 190px;
    white-space: nowrap; 
    height: 36px;
    display: flex;
    flex-shrink: 0;
  }

  #sortSelected {
    display: inline-flex;;
    align-items: center;
    gap: 4px;
    padding: 0 12px;
    font-size: 14px;
    max-width: none;
    width: 100%;
    border: 2px solid var(--accent);
    border-radius: 6px;
    background-color: var(--card-bg);
    white-space: nowrap;
    color: var(--text);
    cursor: pointer;
    box-sizing: border-box;
  }

  #sortSelected.open {
    border-radius: 6px 6px 0 0;
  }

  #sortOptions .option {
    font-size: 14px;
    padding: 8px 12px;
    cursor: pointer;
  }

  #sortOptions .option:hover {
    background: var(--accent-dim);
    color: black;
  }

  .tooltip {
    position: fixed;
    background: var(--card-bg);
    color: #fff;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 13px;
    border: 2px solid var(--accent);
    opacity: 0;
    pointer-events: none;
    transform: translateY(-4px);
    transition: opacity 0.15s ease, transform 0.15s ease;
    z-index: 9999;
  }

  .tooltip.show {
    opacity: 1;
    transform: translateY(0);
  }

  #mobile-tooltip-box {
    position: fixed;
    bottom: 20px;            
    left: 50%;
    transform: translateX(-50%);
    max-width: 90%;
    background: var(--card-bg);
    color: white;
    padding: 12px 16px;
    border-radius: 6px;
    font-size: 14px;
    z-index: 9999;
    text-align: center;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.25s ease; 
    border: 2px solid var(--accent);
  }

  #mobile-tooltip-box.show {
    bottom: 20px;
    opacity: 1;
  }

  @media (max-width: 600px) {
    li {
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .result-left {
      max-width: none;
    }
    .result-right {
      justify-content: center;
      margin-top: 10px;
    }
    .result-left, .result-right {
      max-width: none;
      width: 100%;
    }
    .result-right span.pill {
      font-size: 12px;
      padding: 2px 6px;
    }
    .result-right span.arrow {
      border-top: 4px solid transparent;
      border-bottom: 4px solid transparent;
      border-left: 8px solid var(--accent);
      margin: 0 4px;
    }
    .controls {
      flex-direction: column;
    }
  }
</style>
</head>
<body>
<div class="container">
  <img src="/assets/CoverImage.webp" 
       alt="Fallout 76 C.A.M.P. Item Lookup" 
       style="display:block; margin:0 auto; max-width:100%; height:auto;">
  <div class="meta">
    <p class="author">
      Made by <span class="author-name">MrsBlobby</span>
      <a href="https://mrsblobby.github.io/76Tools.html" class="badge-link">Other Tools</a>
    </p>
    <p class="updated">Last Updated: November 15, 2025</p>
  </div>
</div>

    <!-- Version history -->
<div class="container">
    <details>
      <summary>Version History</summary>
       <div class="changelog-entry">
          <h4>v3.0 Beta</h4>
          <ul>
              <li>
                  <div>
                      Expansion towards a more generalized database tool:<br>
                      Added category icons<br>
                      Added placement conditions (plan, entitlement) for objects, and added respective source icons, i.e. SCORE, Gold Bullion, Stamps, Atomic Shop icons. Known issue with beta version: certain plans will not show yet (i.e. Nuclear Winter stash boxes), nor do challenge requirements (i.e. Kelp Curtain). NOTE: THIS TOOL DOES NOT DISTINGUISH BETWEEN WHAT IS AND ISN'T OBTAINABLE. PLEASE DOUBLE CHECK THIS YOURSELF IF APPLICABLE<br>
                      Added search filters<br>
                      General UI cleanup<br>
                      Full v3.0 release will also list CAMP budget costs, have more source icons, and include further polishing of minor issues
                  </div>
              </li>
          </ul>
      </div>
      <div class="changelog-entry">
        <h4>v2.3.1</h4>
        <ul><li>Fixed issue that caused crops to not have preview images</li></ul>
      </div>
      <div class="changelog-entry">
        <h4>v2.3</h4>
        <ul><li>Results are now displayed in pages of up to 50 entries in an effort to optimize performance</li></ul>
      </div>
      <div class="changelog-entry">
        <h4>v2.2.1</h4>
        <ul><li>Hid entries that returned null as a name in database</li></ul>
      </div>
      <div class="changelog-entry">
        <h4>v2.2</h4>
        <ul><li>Added sorting options</li></ul>
      </div>
      <div class="changelog-entry">
        <h4>v2.1.2</h4>
        <ul><li>Fixed issue that caused a lot of Turret entries to be missing</li></ul>
      </div>
      <div class="changelog-entry">
        <h4>v2.1.1</h4>
        <ul><li>Fixed Fauna subcategory not displaying correctly</li></ul>
      </div>
      <div class="changelog-entry">
        <h4>v2.1</h4>
        <ul><li>Added embed when linking tool on Discord</li></ul>
      </div>
      <div class="changelog-entry">
        <h4>v2.0</h4>
        <ul><li>Reworked UI entirely. Added more mobile-friendly UI</li></ul>
      </div>
      <div class="changelog-entry">
        <h4>v1.2</h4>
        <ul><li>Added version history</li></ul>
      </div>
      <div class="changelog-entry">
        <h4>v1.1.1</h4>
        <ul><li>Fixed wallpaper images</li></ul>
      </div>
      <div class="changelog-entry">
        <h4>v1.1</h4>
        <ul><li>Added image support</li></ul>
      </div>
      <div class="changelog-entry">
        <h4>v1.0</h4>
        <ul><li>Initial creation</li></ul>
      </div>
    </details>
  </div>

<div class="controls">
  <div class="search-line">
    <input type="text" id="searchBox" placeholder="Search..." />
    <div class="custom-dropdown">
      <div id="dropdownSelected">Item Name</div>
      <div id="dropdownOptions">
        <div class="option" data-value="name">Item Name</div>
        <div class="option" data-value="book">Plan Name</div>
        <div class="option" data-value="entm">Entitlement Name</div>
      </div>
    </div>
  </div>

<div class="inline-group">
  <!-- Filters group -->
  <div class="group-filters" style="display: flex; align-items: center;">
    <div class="custom-dropdown" id="filtersDropdown">
      <div id="filtersButton">
        <span class="filters-label">Filters</span>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="filter-icon" style="width:16px; height:16px;">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 0 1-.659 1.591l-5.432 5.432a2.25 2.25 0 0 0-.659 1.591v2.927a2.25 2.25 0 0 1-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 0 0-.659-1.591L3.659 7.409A2.25 2.25 0 0 1 3 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0 1 12 3Z" />
        </svg>
      </div>


      <div id="filtersOptions">
        <div class="filter-columns">
          <div class="filter-header">Placement Condition</div>
          <button data-filter="plan">Plan</button>
          <button data-filter="entitlement">Entitlement</button>
          <button data-filter="challenge">Challenge</button>
          <button data-filter="learn">Learn on Pickup</button>
        </div>

        <div class="filter-columns">
          <div class="filter-header">Workshop Category</div>
          <button data-filter="c.a.m.p. pieces">C.A.M.P. Pieces</button>
          <button data-filter="decorations">Decorations</button>
          <button data-filter="defense">Defense</button>
          <button data-filter="dwellers">Dwellers</button>
          <button data-filter="furniture">Furniture</button>
          <button data-filter="lights">Lights</button>
          <button data-filter="power">Power</button>
          <button data-filter="quest">Quest</button>
          <button data-filter="resources">Resource</button>
          <button data-filter="storage">Storage</button>
          <button data-filter="structure">Structure</button>
          <button data-filter="utility">Utility</button>
          <button data-filter="wall decor">Wall Decor</button>
          <button data-filter="wallpapers">Wallpapers</button>
        </div>
      </div>
    </div>

    <!-- Attached Clear All button -->
    <button class="clear-filters" id="clearFiltersExternal">Clear</button>
  </div>

  <!-- Sort group -->
  <div class="group-sort">
    <div class="custom-dropdown" id="sortDropdown">
     <div id="sortSelected">Sort By: Workshop Menu ▼</div>
      <div id="sortOptions">
        <div class="option" data-value="camp-top">Workshop Menu ▼</div>
        <div class="option" data-value="camp-bottom">Workshop Menu ▲</div>
        <div class="option" data-value="az">Alphabetical ▼</div>
        <div class="option" data-value="za">Alphabetical ▲</div>
	<div class="option" data-value="budget-high-low">Budget Cost ▼</div>
	<div class="option" data-value="budget-low-high">Budget Cost ▲</div>
        <div class="option" data-value="old-new">Oldest</div>
        <div class="option" data-value="new-old">Newest</div>
      </div>
    </div>
  </div>
</div>

  <ul id="results"></ul>
  <div id="pagination" style="text-align:center; margin: 16px 0;"></div>

<script>
let db = [];
let currentPage = 1;
const itemsPerPage = 50;
let lastQuery = '';
let currentSort = 'camp-top';
let currentSearchBy = 'name';
let activeFilters = new Set()

function initLazyImages(options = {}) {
  const selector = options.selector || 'img.lazy[data-src]';
  const preloadDelay = options.preloadDelay || 2000;
  const batchSize = options.batchSize || 5;
  const batchInterval = options.batchInterval || 100;

  const lazyImages = new Set(document.querySelectorAll(selector));

  // Lazy-load images when they enter the viewport
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        img.src = img.dataset.src;
        img.classList.remove('lazy');
        lazyImages.delete(img);
        observer.unobserve(img);
      }
    });
  }, {
    rootMargin: '200px 0px',
    threshold: 0.1
  });

  lazyImages.forEach(img => observer.observe(img));

  // Slowly preload remaining images in batches
  function preloadRemaining() {
    const imgs = Array.from(lazyImages);
    let i = 0;

    function batch() {
      for (let j = 0; j < batchSize && i < imgs.length; j++, i++) {
        if (!imgs[i].src) imgs[i].src = imgs[i].dataset.src;
        lazyImages.delete(imgs[i]);
      }
      if (i < imgs.length) setTimeout(batch, batchInterval);
    }

    batch();
  }

  setTimeout(preloadRemaining, preloadDelay);
}



// --- Category Icons ---
const CategoryIcons = {
  'Quest': '/assets/MainCategory-QuestsIcon.svg',
  'Objectives': '/assets/MainCategory-QuestsIcon.svg',
  'Modify': '/assets/MainCategory-ModifyIcon.svg',
  'Wallpapers': '/assets/MainCategory-WallpapersIcon.svg',
  'C.A.M.P. Pieces': '/assets/MainCategory-CAMPPiecesIcon.svg',
  'Foundations': '/assets/SubCategory-FoundationsIcon.webp',
  'Decorations': '/assets/MainCategory-DecorationsIcon.svg',
  'Defense': '/assets/MainCategory-DefensesIcon.svg',
  'Dwellers': '/assets/MainCategory-DwellersIcon.svg',
  'Furniture': '/assets/MainCategory-FurnitureIcon.svg',
  'Lights': '/assets/MainCategory-LightsIcon.svg',
  'Power': '/assets/MainCategory-PowerIcon.svg',
  'Resources': '/assets/MainCategory-ResourcesIcon.svg',
  'Storage': '/assets/MainCategory-StorageIcon.svg',
  'Utility': '/assets/MainCategory-UtilityIcon.svg',
  'Wall Decor': '/assets/MainCategory-WallDecorIcon.svg',
  'Structure': '/assets/MainCategory-StructureIcon.svg',
  'Porches': '/assets/SubCategory-PorchesIcon.webp',
  'Floors':'/assets/SubCategory-FloorsIcon.webp',
  'Walls': '/assets/SubCategory-WallsIcon.webp',
  'Roofs': '/assets/SubCategory-RoofsIcon.webp',
  'Stairs': '/assets/SubCategory-StairsIcon.webp',
  'Shelters': '/assets/SubCategory-SheltersIcon.webp',
  'Doors': '/assets/SubCategory-DoorsIcon.webp',
  'Columns': '/assets/SubCategory-ColumnsIcon.webp',
  'Fences': '/assets/SubCategory-FencesIcon.webp',
  'Barricades': '/assets/SubCategory-BarricadeIcon.webp',
  'Traps': '/assets/SubCategory-TrapsIcon.webp',
  'Turrets': '/assets/SubCategory-TurretsIcon.webp',
  'Generators': '/assets/SubCategory-GeneratorsIcon.webp',
  'Power Connectors': '/assets/SubCategory-PowerConnectorsIcon.webp',
  'Candles': '/assets/SubCategory-CandleIcon.webp',
  'Ceiling Lights': '/assets/SubCategory-CeilingLightsIcon.webp',
  'Fire': '/assets/SubCategory-FireIcon.webp',
  'Lamps': '/assets/SubCategory-LampsIcon.svg',
  'Wall Lights': '/assets/SubCategory-WallLightsIcon.webp',
  'Crafting': '/assets/SubCategory-CraftingIcon.webp',
  'Collectors': '/assets/SubCategory-CollectorsIcon.webp',
  'Food': '/assets/SubCategory-FoodIcon.webp',
  'Producers': '/assets/SubCategory-ProducersIcon.webp',
  'Water': '/assets/SubCategory-WaterIcon.webp',
  'Instruments': '/assets/SubCategory-InstrumentsIcon.webp',
  'Player Buffs': '/assets/SubCategory-PlayerBuffsIcon.webp',
  'Services': '/assets/SubCategory-ServicesIcon.webp',
  'Vending Machines': '/assets/SubCategory-VendingMachinesIcon.webp',
  'Appliances': '/assets/SubCategory-AppliancesIcon.webp',
  'Beds': '/assets/SubCategory-BedsIcon.webp',
  'Electronics': '/assets/SubCategory-ElectronicsIcon.webp',
  'Seating': '/assets/SubCategory-SeatingIcon.webp',
  'Shelves': '/assets/SubCategory-ShelvesIcon.webp',
  'Surfaces': '/assets/SubCategory-SurfacesIcon.webp',
  'Balloons': '/assets/SubCategory-BalloonsIcon.webp',
  'Clutter': '/assets/SubCategory-ClutterIcon.webp',
  'Crockery': '/assets/SubCategory-CrockeryIcon.webp',
  'Entertainment': '/assets/SubCategory-EntertainmentIcon.webp',
  'Fauna': '/assets/SubCategory-FaunaIcon.webp',
  'Lawn & Garden': '/assets/SubCategory-Lawn&GardenIcon.webp',
  'Novelties': '/assets/SubCategory-NoveltiesIcon.webp',
  'Outdoor': '/assets/SubCategory-OutdoorIcon.webp',
  'Rugs': '/assets/SubCategory-RugsIcon.webp',
  'Signs': '/assets/SubCategory-SignsIcon.webp',
  'Statues': '/assets/SubCategory-StatuesIcon.webp',
  'Taxidermy': '/assets/SubCategory-TaxidermyIcon.webp',
  'Toys': '/assets/SubCategory-ToysIcon.webp',
  'Vehicles': '/assets/SubCategory-VehiclesIcon.webp',
  'Accents': '/assets/SubCategory-AccentsIcon.webp',
  'Ceiling': '/assets/SubCategory-CeilingIcon.webp',
  'Holiday': '/assets/SubCategory-HolidayIcon.webp',
  'Mounted': '/assets/SubCategory-MountedIcon.webp',
  'Tapestry': '/assets/SubCategory-TapestryIcon.webp',
  'Wall Art': '/assets/SubCategory-WallArtIcon.webp',
  'Wall Letters': '/assets/SubCategory-WallLettersIcon.webp',
  'Window': '/assets/SubCategory-WindowIcon.webp',
  'Additional Storage': '/assets/SubCategory-AdditionalStorageIcon.svg',
  'Displays': '/assets/SubCategory-DisplaysIcon.webp',
  'Stash Boxes': '/assets/SubCategory-StashBoxesIcon.webp',
  'Farm': '/assets/SubCategory-FarmIcon.webp',
  'Frontier': '/assets/SubCategory-FrontierIcon.webp',
  'Industrial': '/assets/SubCategory-IndustrialIcon.webp',
  'Military': '/assets/SubCategory-MilitaryIcon.webp',
  'Modern': '/assets/SubCategory-ModernIcon.webp',
  'Retail': '/assets/SubCategory-RetailIcon.webp',
  'Rustic': '/assets/SubCategory-RusticIcon.webp',
  'Scavenger': '/assets/SubCategory-ScavengerIcon.webp',
  'Allies': '/assets/SubCategory-AlliesIcon.svg',
  'Pets': '/assets/SubCategory-PetsIcon.webp',
  'Pet Furniture': '/assets/SubCategory-PetFurnitureIcon.webp'
};

window.addEventListener('DOMContentLoaded', () => {
  // Clear search bar
  const searchBox = document.getElementById('searchBox');
  searchBox.value = '';
  lastQuery = '';

  // Hide all dropdowns on load
  const filtersOptions = document.getElementById('filtersOptions');
  filtersOptions.classList.remove('open');

  const filtersButton = document.getElementById('filtersButton');
  filtersButton.classList.remove('open');

  const dropdownOptions = document.getElementById('dropdownOptions');
  dropdownOptions.classList.remove('open');
  dropdownSelected.classList.remove('open');

  const sortOptions = document.getElementById('sortOptions');
  sortOptions.classList.remove('open');
  sortSelected.classList.remove('open');

  // Optional: render all results initially
  renderResults('');
});

function createTooltipElement(text) {
  const t = document.createElement('div');
  t.className = 'tooltip';
  t.textContent = text;
  document.body.appendChild(t);
  return t;
}

let mobileTooltipTimeout = null; // for resetting hide timer

function attachTooltipToIcon(icon, text) {
  const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

  if (!isTouch) {
    // --- Desktop Tooltip ---
    const desktopTooltip = createTooltipElement(text);

    function showDesktop() {
      const rect = icon.getBoundingClientRect();
      const w = desktopTooltip.offsetWidth;
      const h = desktopTooltip.offsetHeight;
      desktopTooltip.style.left = `${rect.left + rect.width / 2 - w / 2}px`;
      desktopTooltip.style.top  = `${rect.top - h - 6}px`;
      desktopTooltip.classList.add('show');
    }

    function hideDesktop() {
      desktopTooltip.classList.remove('show');
    }

    icon.addEventListener('mouseenter', showDesktop);
    icon.addEventListener('mouseleave', hideDesktop);

  } else {
    // --- Mobile Tooltip ---
    icon.addEventListener('click', (e) => {
      e.stopPropagation();

      let box = document.getElementById('mobile-tooltip-box');
      if (!box) {
        box = document.createElement('div');
        box.id = 'mobile-tooltip-box';
        document.body.appendChild(box);
      }
    
      box.textContent = text;
    
      // reset animation
      box.classList.remove('show');
      void box.offsetWidth; // force reflow
      box.classList.add('show');
    
      clearTimeout(mobileTooltipTimeout);
      mobileTooltipTimeout = setTimeout(() => {
        box.classList.remove('show');
      }, 2000);
    });

  }
}

const IconAltText_BOOK = {
    BullionVendor: {
      vendors: ['Minerva', 'Mortimer', 'Samuel', 'Regs', 'Windy'],
      get alt() { return `Sold by Gold Bullion Vendor (${this.vendors.join(', ')})`; }
    },
    StampsVendor: { alt: "Sold by Giuseppe Della Ripa" },
    DailyOps: { alt: "Daily Ops Reward" },
    CommonWorkshop: { alt: "Common Workshop Claim/Defense Reward" },
    RaidsReward: { alt: "Gleaming Depths Raid Reward" },
    TreasureHunters: { alt: "Treasure Hunters Event Reward" },
    MeatWeekRewards: { alt: "Meat Week Seasonal Event Reward" },
    FasnachtRewards: { alt: "Fasnacht Seasonal Event Reward" },
    MischiefNightRewards: { alt: "Mischief Night Seasonal Event Reward" },
    SpookyScorched: { alt: "Spooky Scorched Seasonal Event Reward" },
    PublicEventRewards: { alt: "Public Event Reward" },
    EquinoxRewards: { alt: "Mothman Equinox Seasonal Event Reward" },
    GrahmVendor: { alt: "Sold by Grahm" },
    UnusedContent: { alt: "Unused Content"},
    ColossalProblemRewards: { alt: "Reward from Event: A Colossal Problem" },
    BeastsOfBurdenRewards: { alt: "Reward from Event: Beasts of Burden" },
    CampfireTalesRewards: { alt: "Reward from Event: Campfire Tales" },
    DangerousPastimesRewards: { alt: "Reward from Event: Dangerous Pastimes" },
    MoonshineJamboreeRewards: { alt: "Reward from Event: Moonshine Jamboree" },
    MostWantedRewards: { alt: "Reward from Event: Most Wanted" },
    NWOTGenericRewards: { alt: "Reward from Event: Most Wanted, Spin the Wheel, Tunnel of Love" },
    NeurologicalWarfareRewards: { alt: "Reward from Event: Neurological Warfare" },
    RadiationRumbleRewards: { alt: "Reward from Event: Radiation Rumble" },
    SafeAndSoundRewards: { alt: "Reward from Event: Safe and Sound" },
    SeismicActivityRewards: { alt: "Reward from Event: Seismic Activity" },
    SpinTheWheelRewards: { alt: "Reward from Event: Spin the Wheel" },
    TestYourMetalRewards: { alt: "Reward from Event: Test Your Metal" },
    TunnelOfLoveRewards: { alt: "Reward from Event: Tunnel of Love" },
    GearinUpRewards: { alt: "Reward from Event: Gearin' Up" },
    SinkholeSolutionsRewards: { alt: "Reward from Event: Sinkhole Solutions" } 
  };

function getTooltipText_BOOK(tag) {
  // Normalize all BullionVendor variants to the single key
  if (tag.startsWith('BullionVendor')) tag = 'BullionVendor';

  const entry = IconAltText_BOOK[tag];
  if (!entry) return tag;

  // Return alt property if exists, otherwise fallback to tag
  return entry.alt || tag;
}


function getTooltipText_ENTM(edid, fullName) {
  const edidUpper = String(edid || "").toUpperCase();
  const fullUpper = String(fullName || "").toUpperCase();

  // direct exact match
  if (IconAltText_ENTM[edidUpper]) return IconAltText_ENTM[edidUpper];
  if (IconAltText_ENTM[fullUpper]) return IconAltText_ENTM[fullUpper];

  // prefix matches (Babylon_, Shelters_, ATX, SCORE)
  for (const key in IconAltText_ENTM) {
    if (edidUpper.includes(key)) return IconAltText_ENTM[key];
    if (fullUpper.includes(key)) return IconAltText_ENTM[key];
  }

  // fallback
  return fullName;
}


const IconAltText_ENTM = {
  "F1_ENTM_CAMP_SCRAPBOX_STANDARD": "Requires Fallout 1st Subscription",
  "F1_ENTM_CAMP_AMMOSTORAGEBOX_STANDARD": "Requires Fallout 1st Subscription",
  "F1_ENTM_CAMP_AIDBOX_STANDARD": "Requires Fallout 1st Subscription",

  // manual EDID prefix mappings
  BABYLON_: "Nuclear Winter Reward",
  SHELTERS_: "Atomic Shop Item",

  // fallbacks
  ATX: "Atomic Shop Item",
  SCORE: "S.C.O.R.E. Reward",
};


// --- Manual icon overrides ---
const ManualEntmIcons = {
  'Babylon_': '/assets/V51Icon.webp',
  'Shelters_': '/assets/AtomIcon.webp',
};
const miniSeasonAliases = {
  'SCORE_MiniSeason_2025_MMMFE': 'Marshal Mallow'
};

// --- Fetch DB ---
fetch('final_workshop_db.json')
  .then(response => response.json())
  .then(data => {
    db = data;
    renderResults('');
  })
  .catch(err => {
    console.error("Failed to load database:", err);
    document.getElementById('results').innerHTML = '<li>Error loading database.</li>';
  });

// --- Dropdown elements ---
const dropdownSelected = document.getElementById('dropdownSelected');
dropdownSelected.textContent = 'Search By: Item Name';
const dropdownOptions = document.getElementById('dropdownOptions');
const sortSelected = document.getElementById('sortSelected');
const sortOptions = document.getElementById('sortOptions');
const sortLabel = document.getElementById('sortLabel');
const filtersButton = document.getElementById('filtersButton');
const filtersOptions = document.getElementById('filtersOptions');
const clearFiltersBtn = document.querySelector('.clear-filters');

// --- Close logic ---
function closeAllDropdowns() {
  dropdownOptions.classList.remove('open');
  dropdownSelected.classList.remove('open');
  sortOptions.classList.remove('open');
  sortSelected.classList.remove('open');
  filtersOptions.classList.remove('open');
  filtersButton.classList.remove('open');
}


function closeOtherDropdowns(except) {
  if (except !== 'search') {
    dropdownOptions.classList.remove('open');
    dropdownSelected.classList.remove('open');
  }
  if (except !== 'sort') {
    sortOptions.classList.remove('open');
    sortSelected.classList.remove('open');
  }
  if (except !== 'filters') {
    filtersOptions.classList.remove('open');
    filtersButton.classList.remove('open');
  }
}

// --- Search By dropdown ---
dropdownSelected.addEventListener('click', e => {
  e.stopPropagation();
  const isOpen = dropdownOptions.classList.contains('open');
  closeAllDropdowns();
  if (!isOpen) {
    dropdownOptions.classList.add('open');
    dropdownSelected.classList.add('open');
  }
});

// --- Initial button text ---
sortSelected.textContent = 'Sort By: Workshop Menu ▼';

// --- Toggle dropdown on button click ---
sortSelected.addEventListener('click', e => {
  e.stopPropagation();
  const isOpen = sortOptions.classList.contains('open');
  closeAllDropdowns(); // Close other dropdowns first
  if (!isOpen) {
    sortOptions.classList.add('open');
    sortSelected.classList.add('open');
  }
});

// --- Option click handler ---
sortOptions.querySelectorAll('.option').forEach(option => {
  option.addEventListener('click', e => {
    e.stopPropagation();
    currentSort = option.dataset.value;

    // Update the whole button text, preserving prefix
    sortSelected.textContent = 'Sort By: ' + option.textContent.trim();

    // Close dropdown
    sortOptions.classList.remove('open');
    sortSelected.classList.remove('open');

    // Refresh results
    const searchBox = document.getElementById('searchBox');
    renderResults(searchBox ? searchBox.value : '');
  });
});


// --- Close dropdown if clicking elsewhere ---
document.addEventListener('click', () => {
  sortOptions.classList.remove('open');
  sortSelected.classList.remove('open');
});

function updateFiltersButton() {
  const count = activeFilters.size;

  // Find or create label span
  let label = filtersButton.querySelector('.filters-label');
  if (!label) {
    // Remove any existing text nodes (except the SVG)
    Array.from(filtersButton.childNodes).forEach(node => {
      if (node.nodeType === Node.TEXT_NODE) node.remove();
    });

    label = document.createElement('span');
    label.className = 'filters-label';
    filtersButton.prepend(label); // add before the SVG
  }

  // Update text
  label.textContent = count ? `Filters: ${count}` : 'Filters';

  // Highlight if active
  if (count) {
    filtersButton.classList.add('active');
  } else {
    filtersButton.classList.remove('active');
  }
}


// --- Filters dropdown ---
filtersButton.addEventListener('click', e => {
  e.stopPropagation();
  const isOpen = filtersOptions.classList.contains('open');
  closeAllDropdowns(); // Close everything before toggling filters
  if (!isOpen) {
    filtersOptions.classList.add('open');
    filtersButton.classList.add('open');
  }
});

// Prevent clicks inside filters dropdown from closing it
filtersOptions.addEventListener('click', e => e.stopPropagation());

// Clear button handler
clearFiltersBtn.addEventListener('click', e => {
  e.stopPropagation();

  // Close the other two dropdowns (always)
  dropdownOptions.classList.remove('open');
  dropdownSelected.classList.remove('open');
  sortOptions.classList.remove('open');
  sortSelected.classList.remove('open');

  // Clear activeFilters data and UI
  activeFilters.clear();
  filtersOptions.querySelectorAll('button[data-filter].selected')
    .forEach(btn => btn.classList.remove('selected'));

  // Update Filters button text and highlight
  updateFiltersButton();

  // Refresh results using current searchbox value (safe lookup)
  const sb = document.getElementById('searchBox');
  renderResults(sb ? sb.value : '');
});


// --- Global click closes everything ---
document.addEventListener('click', () => closeAllDropdowns());


// --- Search & Sort Options ---
dropdownOptions.querySelectorAll('.option').forEach(option => {
  option.addEventListener('click', () => {
    currentSearchBy = option.dataset.value;
    dropdownSelected.textContent = 'Search By: ' + option.textContent;
    dropdownOptions.classList.remove('open');
    dropdownSelected.classList.remove('open');
    renderResults(document.getElementById('searchBox').value);
  });
});

document.getElementById('searchBox').addEventListener('input', e => renderResults(e.target.value));

// --- Sorting / Pagination ---
function sortItems(items) {
  switch(currentSort) {
    case 'camp-bottom': return [...items].reverse();
    case 'new-old': return [...items].sort((a,b) => (b.CNAM_FormID || '').localeCompare(a.CNAM_FormID || ''));
    case 'old-new': return [...items].sort((a,b) => (a.CNAM_FormID || '').localeCompare(b.CNAM_FormID || ''));
    case 'az': return [...items].sort((a,b) => (a.Name || '').localeCompare(b.Name || ''));
    case 'za': return [...items].sort((a,b) => (b.Name || '').localeCompare(a.Name || ''));
    case 'budget-high-low': return [...items].sort((a, b) => (b.BudgetCost || 0) - (a.BudgetCost || 0));
    case 'budget-low-high': return [...items].sort((a, b) => (a.BudgetCost || 0) - (b.BudgetCost || 0));
    default: return items;
  }
}

function paginate(items) {
  const start = (currentPage - 1) * itemsPerPage;
  const end = start + itemsPerPage;
  return items.slice(start, end);
}

function renderPagination(totalItems) {
  const pagination = document.getElementById('pagination');
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  pagination.innerHTML = '';
  if (totalPages <= 1) return;

  const prevBtn = document.createElement('button');
  prevBtn.textContent = '← Prev';
  prevBtn.disabled = currentPage === 1;
  prevBtn.onclick = () => { currentPage--; renderResults(document.getElementById('searchBox').value); };
  pagination.appendChild(prevBtn);

  for (let i=1; i<=totalPages; i++) {
    if (i === 1 || i === totalPages || Math.abs(i-currentPage) <= 2) {
      const btn = document.createElement('button');
      btn.textContent = i;
      btn.style.fontWeight = i===currentPage ? 'bold' : 'normal';
      btn.onclick = () => { currentPage = i; renderResults(document.getElementById('searchBox').value); };
      pagination.appendChild(btn);
    } else if (Math.abs(i-currentPage) === 3) {
      const span = document.createElement('span');
      span.textContent = ' ... ';
      pagination.appendChild(span);
    }
  }

  const nextBtn = document.createElement('button');
  nextBtn.textContent = 'Next →';
  nextBtn.disabled = currentPage === totalPages;
  nextBtn.onclick = () => { currentPage++; renderResults(document.getElementById('searchBox').value); };
  pagination.appendChild(nextBtn);
}

filtersOptions.querySelectorAll('button[data-filter]').forEach(btn => {
  btn.addEventListener('click', () => {
    const filter = btn.dataset.filter;
    if (activeFilters.has(filter)) {
      activeFilters.delete(filter);
      btn.classList.remove('selected');
    } else {
      activeFilters.add(filter);
      btn.classList.add('selected');
    }
    updateFiltersButton();
    renderResults(searchBox.value);
  });
});


// --- Render results ---
function renderResults(query) {
  const normalizedQuery = query.toLowerCase();
  const queryChanged = normalizedQuery !== lastQuery;
  lastQuery = normalizedQuery;

  // --- filters setup ---
  let placementFilters = new Set(['plan', 'entitlement', 'challenge', 'learn']);

  function matchesItem(item) {
  if (activeFilters.size === 0) return true;

  // Separate placement vs category filters
  const placementActive = [...activeFilters].filter(f => placementFilters.has(f));
  const categoryActive  = [...activeFilters].filter(f => !placementFilters.has(f));

  // Determine flags
  const id = String(item.BOOK_EditorID || '').toLowerCase();
  const source = String(item.BOOK_SOURCE || '').toLowerCase();

  const hasChallenge = id.includes('challenge_');
  const hasLearn     = source === 'learnbypickup'; // exact flag
  const hasPlan      = !!item.BOOK_FULL?.trim() && !hasChallenge; // exclude challenges
  const hasEnt       = !!item.ENTM_FULL?.trim();

  let placementMatch = true;

  if (placementActive.length > 0) {
    // --- Plan/Entitlement strict hybrid AND/XOR ---
    if (placementActive.includes('plan') && placementActive.includes('entitlement')) {
      placementMatch = hasPlan && hasEnt; // must have both
    } else if (placementActive.includes('plan')) {
      placementMatch = hasPlan && !hasEnt;
    } else if (placementActive.includes('entitlement')) {
      placementMatch = hasEnt && !hasPlan;
    }

    // --- Challenge and Learn are independent ---
    if (placementActive.includes('challenge')) placementMatch = placementMatch && hasChallenge;
    if (placementActive.includes('learn'))      placementMatch = placementMatch && hasLearn;
  }

  // --- Category/subcategory filters (OR) ---
  const categoryMatch = categoryActive.length === 0 || categoryActive.some(f =>
    (item.Category || '').toLowerCase() === f || (item.SubCategory || '').toLowerCase() === f
  );

  return placementMatch && categoryMatch;
}



  
    

  


  // --- Filter the DB ---
  const filtered = db.filter(item => {
  if (!item.Name || item.Name === 'null' || item.Name.trim() === '') return false;
    // basic search
    let matchesSearch;
    if (!normalizedQuery) matchesSearch = true;
    else if (currentSearchBy === 'name') matchesSearch = item.Name && item.Name.toLowerCase().includes(normalizedQuery);
    else if (currentSearchBy === 'book') matchesSearch = item.BOOK_FULL && item.BOOK_FULL.toLowerCase().includes(normalizedQuery);
    else if (currentSearchBy === 'entm') matchesSearch = item.ENTM_FULL && item.ENTM_FULL.toLowerCase().includes(normalizedQuery);

    const matchesFilters = matchesItem(item); // call the new function

    return matchesSearch && matchesFilters;
  });

  const sorted = sortItems(filtered);

  // reset to page 1 if query changed or current page is out of range
  const totalPages = Math.ceil(sorted.length / itemsPerPage);
  if (queryChanged || currentPage > totalPages) currentPage = 1;

  const paged = paginate(sorted);
  results.innerHTML = '';

  if (!paged.length) {
    results.innerHTML = '<li class="no-results">No matches found</li>';
    pagination.innerHTML = '';
    return;
  }

  paged.forEach(r => {
    if ((r.SubCategory || '').trim().toLowerCase() === 'testsubcat'.toLowerCase()) return;

    const li = document.createElement('li');

    const left = document.createElement('div');
    left.className = 'result-left';

    const name = document.createElement('div');
    name.className = 'result-name';
    name.textContent = r.Name;
    left.appendChild(name);

    // Entry images
    let imgSrc = `Images/${(r.ARTO_FormID || '').toLowerCase()}.webp`;

    // Fallback to CNAM if ARTO image fails to load
    if (!r.ARTO_FormID) {
      imgSrc = `Images/${(r.CNAM_FormID || '').toLowerCase()}.webp`;
    }

    const img = document.createElement('img');
    img.src = imgSrc;
    img.alt = r.Name;
    

    // If ARTO was tried first, fallback on error to CNAM
    if (r.ARTO_FormID && r.CNAM_FormID) {
      img.onerror = function() {
        this.onerror = null; // prevent infinite loop if CNAM also fails
        this.src = `Images/${r.CNAM_FormID.toLowerCase()}.webp`;
      };
    }

    left.appendChild(img);


    const right = document.createElement('div');
    right.className = 'result-right';


    // --- Build Menu Category header + pills ---
    if ((r.Category && r.Category.trim() !== '') || (r.SubCategory && r.SubCategory.trim() !== '')) {
      const catHeader = document.createElement('div');
      catHeader.className = 'section-header';
      catHeader.textContent = 'Build Menu Category';
      right.appendChild(catHeader);

      const catWrap = document.createElement('div');
      catWrap.className = 'inline-wrap';

      const categories = [];

      if (r.Category && r.Category.trim() !== '') {
        if (r.Category.toLowerCase() === 'wallpapers') {
          categories.push('Modify');          
          categories.push(r.Category);        // keep "Wallpapers" as subcategory
        } else {
          categories.push(r.Category);
          if (
            r.SubCategory &&
            r.SubCategory.trim() !== '' &&
            r.Category.toLowerCase() !== 'wallpapers'
          ) {
            categories.push(r.SubCategory);
          }
        }
      }


      categories.forEach((cat, i) => {
        const catSpan = document.createElement('span');
        catSpan.className = 'pill';
        catSpan.textContent = '';

        const iconPath = CategoryIcons[cat];
        if (iconPath) {
          const icon = document.createElement('img');
          icon.src = iconPath;
          const isSVG = iconPath.toLowerCase().endsWith('.svg');
          icon.style.height = isSVG ? '24px' : '30px';
          icon.style.width = 'auto';
          icon.style.verticalAlign = 'middle';
          icon.style.marginRight = '6px';
          catSpan.appendChild(icon);
        }

        catSpan.appendChild(document.createTextNode(cat));
        catWrap.appendChild(catSpan);

        if (i < categories.length - 1) {
          const arrow = document.createElement('span');
          arrow.className = 'arrow';
          catWrap.appendChild(arrow);
        }
      });

      right.appendChild(catWrap);
    }

    // --- Placement Conditions header + pills ---
    const hasBook = !!(r.BOOK_FULL && String(r.BOOK_FULL).trim());
    const hasEntm = !!(r.ENTM_FULL && String(r.ENTM_FULL).trim());
    if (hasBook || hasEntm) {
      const condHeader = document.createElement('div');
      condHeader.className = 'section-header';
      condHeader.textContent = 'Placement Conditions';
      condHeader.style.marginTop = '8px';
      right.appendChild(condHeader);

      const condWrap = document.createElement('div');
      condWrap.className = 'inline-wrap';

      const isDirect = (String(r.BOOK_SOURCE || '').toLowerCase() === 'direct');
      const connectorWord = isDirect ? 'and' : 'or';

if (hasBook) {
  const BookTagIcons = {
    'UnusedContent': '/assets/UnusedContentIcon.svg',
    'BullionVendor': '/assets/BullionIcon.webp',
    'StampsVendor': '/assets/StampIcon.webp',
    'DailyOps': '/assets/DOpsIcon.webp',
    'CommonWorkshop': '/assets/WorkshopIcon.svg',
    'RaidsReward': '/assets/RaidIcon.svg',
    'TreasureHunters': '/assets/TreasureHuntersIcon.webp',
    'MeatWeekRewards': '/assets/MeatWeekIcon.svg',
    'FasnachtRewards': '/assets/FasnachtIcon.svg',
    'MischiefNightRewards': '/assets/MischiefNightIcon.svg',
    'SpookyScorched': '/assets/SpookyScorchedIcon.svg',
    'PublicEventRewards': '/assets/PublicEventIcon.svg',
    'EquinoxRewards': '/assets/EquinoxIcon.svg',
    'GrahmVendor': '/assets/GrahmIcon.webp',
    'ColossalProblemRewards': '/assets/PublicEventIcon.svg',
    'BeastsOfBurdenRewards': '/assets/PublicEventIcon.svg',
    'CampfireTalesRewards': '/assets/PublicEventIcon.svg',
    'DangerousPastimesRewards': '/assets/PublicEventIcon.svg',
    'MoonshineJamboreeRewards': '/assets/PublicEventIcon.svg',
    'MostWantedRewards': '/assets/PublicEventIcon.svg',
    'NWOTGenericRewards': '/assets/PublicEventIcon.svg',
    'NeurologicalWarfareRewards': '/assets/PublicEventIcon.svg',
    'RadiationRumbleRewards': '/assets/PublicEventIcon.svg',
    'SafeAndSoundRewards': '/assets/PublicEventIcon.svg',
    'SeismicActivityRewards': '/assets/PublicEventIcon.svg',
    'SpinTheWheelRewards': '/assets/PublicEventIcon.svg',
    'TestYourMetalRewards': '/assets/PublicEventIcon.svg',
    'TunnelOfLoveRewards': '/assets/PublicEventIcon.svg',
    'GearinUpRewards': '/assets/PublicEventIcon.svg',
    'SinkholeSolutionsRewards': '/assets/PublicEventIcon.svg'
  };

const multiVendorCategories = {
  BullionVendor: {
    icon: '/assets/BullionIcon.webp',
    prefixes: [
      'BullionVendorSamuel', 'BullionVendorMinerva', 'BullionVendorMortimer', 'BullionVendorRegs', 'BullionVendorWindy'
    ],
    displayName: 'Gold Bullion'
  },
  RobotVendor: {
    icon: '/assets/RobotVendorIcon.webp',
    prefixes: ['FreeStatesVendor', 'BrotherhoodVendor', 'RespondersVendor', 'RaiderVendor', 'WhitespringStationVendor']
  }
};



function normalizeTag(tag) {
  // Check multi-vendor categories first
  for (const [key, data] of Object.entries(multiVendorCategories)) {
    if (key === tag || (data.prefixes && data.prefixes.some(p => tag.startsWith(p)))) {
      return key;
    }
  }
  // fallback: single tags
  return tag;
}

function getTooltipTextForTag(tag, originalTags) {
  const normalized = normalizeTag(tag);

  if (normalized in multiVendorCategories) {
    const category = multiVendorCategories[normalized];

    // Map original tags to readable vendor names
    const presentVendors = originalTags
      .filter(t => t === normalized || (category.prefixes && category.prefixes.some(p => t.startsWith(p))))
      .map(t => {
      if (t === normalized) {
          // Special case for BullionVendor
          if (normalized === 'BullionVendor') return 'Gold Bullion';
      
          return normalized.replace('Vendor', '');
      }
    
      const match = category.prefixes.find(p => t.startsWith(p));
      if (!match) return t;
    
      let name = match.replace(normalized, ''); // REMOVE the normalized prefix
      name = name.replace('Vendor', '');        // Remove trailing Vendor
      name = name.replace(/([a-z])([A-Z])/g, '$1 $2'); // Add spacing
      return name.trim();
  });
  

    const vendorLabel =
    normalized === 'BullionVendor'
      ? 'Gold Bullion'
      : normalized.replace('Vendor', '');

   return `Sold by ${vendorLabel} Vendor (${presentVendors.join(', ')})`;

   }

  const entry = IconAltText_BOOK[normalized];
  return entry?.alt || normalized;
}


  const bookFulls = String(r.BOOK_FULL || '')
    .split(';')
    .map(s => s.trim())
    .filter(Boolean);

  const rawTags = String(r.BOOK_SOURCE_TAG || '').trim();

  const tagEntries = rawTags
    .split(';')
    .map(s => s.trim())
    .filter(Boolean);

  const getTagsForBook = (index) => {
    if (bookFulls.length === 1) {
      return rawTags.split(/[;|]/).map(t => t.trim()).filter(Boolean);
    }
    if (tagEntries.length === bookFulls.length) {
      return tagEntries[index].split(/[;|]/).map(t => t.trim()).filter(Boolean);
    }
    return rawTags.split(/[;|]/).map(t => t.trim()).filter(Boolean);
  };

bookFulls.forEach((fullName, i) => {
  const pill = document.createElement('span');
  pill.className = 'pill';

  const tags = getTagsForBook(i);
  const uniqueNormalizedTags = [...new Set(tags.map(normalizeTag))];

  const bookEditorId = (r.BOOK_EditorID || '').split(';')[i]?.trim() || '';
  const globValue = r.GLOB_Value;

  // Track if we appended an icon
  let appendedIcon = false;

  uniqueNormalizedTags.forEach(normalizedTag => {
    let iconSrc = BookTagIcons[normalizedTag];

    // Multi-vendor icon
    if (multiVendorCategories[normalizedTag]?.icon) {
      iconSrc = multiVendorCategories[normalizedTag].icon;
    }

    // Challenge / Learn-on-Pickup icons
    if (/Challenge_/.test(bookEditorId)) {
      iconSrc = '/assets/ChallengeIcon.svg';
    } else if (String(r.BOOK_SOURCE || '').toLowerCase() === 'learnbypickup') {
      iconSrc = '/assets/LearnOnPickupIcon.webp';
    }

    if (!iconSrc) return;

    const icon = document.createElement('img');
    icon.src = iconSrc;
    icon.style.width = 'auto';
    icon.style.height = '30px';
    icon.style.verticalAlign = 'middle';
    icon.style.marginRight = '6px';
    pill.appendChild(icon);

    let tooltipText = getTooltipTextForTag(normalizedTag, tags);
    if (/Challenge_/.test(bookEditorId)) {
      tooltipText = `Challenge: "${fullName}"`;
      if (globValue != null) tooltipText += ` (X/${globValue})`;
    } else if (String(r.BOOK_SOURCE || '').toLowerCase() === 'learnbypickup') {
      tooltipText = `Loot to Unlock`;
    }
    attachTooltipToIcon(icon, tooltipText);

    appendedIcon = true;
  });

  // If no tags produced an icon, still add Challenge/Learn icon
  if (!appendedIcon) {
    let iconSrc = '';
    let tooltipText = '';
    if (/Challenge_/.test(bookEditorId)) {
      iconSrc = '/assets/ChallengeIcon.svg';
      tooltipText = `Complete a Challenge to Unlock`;
    } else if (String(r.BOOK_SOURCE || '').toLowerCase() === 'learnbypickup') {
      iconSrc = '/assets/LearnOnPickupIcon.webp';
      tooltipText = `Loot to Unlock`;
    }

    if (iconSrc) {
      const icon = document.createElement('img');
      icon.src = iconSrc;
      icon.style.width = 'auto';
      icon.style.height = '30px';
      icon.style.verticalAlign = 'middle';
      icon.style.marginRight = '6px';
      pill.appendChild(icon);
      attachTooltipToIcon(icon, tooltipText);
    }
  }

  // Pill text
  let pillText = fullName;
  if (/Challenge_/.test(bookEditorId)) {
    pillText = `Challenge: "${fullName}"`;
    if (globValue != null) pillText += ` (X/${globValue})`;
  } else if (String(r.BOOK_SOURCE || '').toLowerCase() === 'learnbypickup') {
    pillText = `Loot: ${fullName}`;
  }

  pill.appendChild(document.createTextNode(pillText));
  condWrap.appendChild(pill);

  // Connector
  if (i < bookFulls.length - 1) {
    const conn = document.createElement('span');
    conn.className = 'connector';
    conn.textContent = 'and';
    condWrap.appendChild(conn);
  }
});


}

 // --- connector ---
 if (hasBook && hasEntm) {
   const conn = document.createElement('span');
   conn.className = 'connector';
   conn.textContent = connectorWord;
   condWrap.appendChild(conn);
 }


 // --- ENTM pills ---
if (hasEntm) {
  // Prepare lists
  const entmFulls = String(r.ENTM_FULL || '')
    .split(';')
    .map(s => s
      .replace(/[\s;]*UTILITY_ENTM_ItemDisableEntitlement\s*\[ENTM:[0-9A-Fa-f]+\][\s;]*/gi, '')
      .trim()
    )
    .filter(Boolean);

  let entmEdids = String(r.ENTM_EDID || '')
    .split(';')
    .map(s => s.trim())
    .filter(Boolean);

  const ExactPairs = {
    'SCRAPBOX': 'F1_ENTM_CAMP_ScrapBox_Standard',
    'AMMO STORAGE BOX': 'F1_ENTM_CAMP_AmmoStorageBox_Standard',
    'AID BOX': 'F1_ENTM_CAMP_AidBox_Standard'
  };

  const norm = txt => String(txt || '').toUpperCase().replace(/[^A-Z0-9]/g, '');

  function findAndRemoveEdid(pred) {
    const idx = entmEdids.findIndex(pred);
    return idx >= 0 ? entmEdids.splice(idx, 1)[0] : '';
  }

  const reservedEdidMap = {};
  entmFulls.forEach(full => {
    const key = full.trim().toUpperCase();
    if (ExactPairs[key]) {
      const expected = ExactPairs[key];
      let matched = findAndRemoveEdid(e => e.toUpperCase() === expected.toUpperCase())
        || findAndRemoveEdid(e => e.toUpperCase().includes(expected.toUpperCase()))
        || findAndRemoveEdid(e => expected.toUpperCase().includes(e.toUpperCase()));
      if (matched) reservedEdidMap[full] = matched;
    }
  });

  function pickBestEdidForFull(fullName) {
    if (!entmEdids.length) return '';
    const fullNorm = norm(fullName);

    let idx = entmEdids.findIndex(e => norm(e) === fullNorm);
    if (idx >= 0) return entmEdids.splice(idx, 1)[0];

    idx = entmEdids.findIndex(e => fullName.includes(e) || e.includes(fullName));
    if (idx >= 0) return entmEdids.splice(idx, 1)[0];

    const fullTokens = fullName.toUpperCase().split(/[^A-Z0-9]+/).filter(Boolean);
    let bestIdx = -1, bestScore = 0;
    entmEdids.forEach((e, i) => {
      const eTokens = e.toUpperCase().split(/[^A-Z0-9]+/).filter(Boolean);
      const score = fullTokens.reduce((s, t) => s + (eTokens.includes(t) ? 1 : 0), 0);
      if (score > bestScore) { bestScore = score; bestIdx = i; }
    });
    if (bestIdx >= 0 && bestScore > 0) return entmEdids.splice(bestIdx, 1)[0];

    return entmEdids.length ? entmEdids.splice(0,1)[0] : '';
  }

  const entmPills = [];

  entmFulls.forEach(fullName => {
    const matchedEdid = reservedEdidMap[fullName] || pickBestEdidForFull(fullName);
    const edidUpper = String(matchedEdid || '').toUpperCase();
    const fullUpper = fullName.trim().toUpperCase();

    // Decide icon
    let iconSrc = '';
    if (ExactPairs[fullUpper] && (edidUpper === ExactPairs[fullUpper] || edidUpper.includes(ExactPairs[fullUpper]) || edidUpper.startsWith('F1_ENTM'))) {
      iconSrc = '/assets/SubCategory-AdditionalStorageIcon.svg';
    }
    if (!iconSrc) {
      for (const key in ManualEntmIcons) {
        if (edidUpper.startsWith(key.toUpperCase())) {
          iconSrc = ManualEntmIcons[key];
          break;
        }
      }
    }
    if (!iconSrc && edidUpper.startsWith('F1_ENTM')) iconSrc = '/assets/SubCategory-AdditionalStorageIcon.svg';
    if (!iconSrc) {
      if (edidUpper.includes('ATX')) iconSrc = '/assets/AtomIcon.webp';
      else if (edidUpper.includes('SCORE_MINISEASON') || /SCORE[_-]?MINISEASON/i.test(matchedEdid)) iconSrc = '/assets/SeasonIcon.webp';
      else if (/SCORE[_-]?S?\d+/i.test(matchedEdid) || edidUpper.includes('SCORE')) iconSrc = '/assets/SeasonIcon.webp';
    }

    // Build pill
    const pill = document.createElement('span');
    pill.className = 'pill';
      
    if (iconSrc) {
      const icon = document.createElement('img');
      icon.src = iconSrc;
      icon.style.width = '30px';
      icon.style.height = '30px';
      icon.style.verticalAlign = 'middle';
      icon.style.marginRight = '6px';
      pill.appendChild(icon);
    
      let tooltipText = fullName; // fallback
        const edidUpper = String(matchedEdid || '').toUpperCase();

        // 1️startsWith priority
        for (const key in IconAltText_ENTM) {
          if (edidUpper.startsWith(key.toUpperCase())) {
            tooltipText = IconAltText_ENTM[key];
            break;
          }
        }

        // 2️fallback includes (only if not already matched)
        if (tooltipText === fullName) {
          for (const key in IconAltText_ENTM) {
            if (edidUpper.includes(key.toUpperCase())) {
              tooltipText = IconAltText_ENTM[key];
              break;
            }
          }
        }

      attachTooltipToIcon(icon, tooltipText); 
    }
    
    
    
    // Optional season suffix
    let textSuffix = '';
    if (matchedEdid) {
      if (miniSeasonAliases[matchedEdid]) textSuffix = ` (Mini Season: ${miniSeasonAliases[matchedEdid]})`;
      else {
        const miniMatch = matchedEdid.match(/MiniSeason_\d+_([A-Za-z0-9]+)/i);
        if (miniMatch) textSuffix = ` (Mini Season: ${miniMatch[1].replace(/([a-z])([A-Z])/g,'$1 $2')})`;
        else {
          const seasonMatch = matchedEdid.match(/SCORE[_]?S?(\d+)/i);
          if (seasonMatch) textSuffix = ` (Season ${seasonMatch[1]})`;
        }
      }
    }

    pill.appendChild(document.createTextNode(fullName + textSuffix));
    entmPills.push(pill);
  });

  // Append pills with connectors
  entmPills.forEach((pill, i) => {
    condWrap.appendChild(pill);
    if (i < entmPills.length - 1) {
      const conn = document.createElement('span');
      conn.className = 'connector';
      conn.textContent = 'and';
      condWrap.appendChild(conn);
    }
  });
}

      right.appendChild(condWrap);
    }

// --- Budget Cost header + pill ---
if (r.BudgetCost !== undefined && r.BudgetCost !== null && (r.Category || '').toLowerCase() !== 'wallpapers') {
  const budgetHeader = document.createElement('div');
  budgetHeader.className = 'section-header';
  budgetHeader.textContent = 'Budget Cost';
  budgetHeader.style.marginTop = '8px';
  right.appendChild(budgetHeader);

  const budgetWrap = document.createElement('div');
  budgetWrap.className = 'inline-wrap';

  const budgetPill = document.createElement('span');
  budgetPill.className = 'pill';

  // Round to 1 decimal
  const roundedBudget = Math.round(r.BudgetCost * 100) / 100;

  // Budget cost labels for purposes of icon tooltips
  const BudgetTierLabels = {
  1: 'Very Low',
  2: 'Low',
  3: 'Medium',
  4: 'High',
  5: 'Very High'
  };


  // ---- Budget Tiers ----
  let budgetIcon = '';
  let budgetTier = 5; // default

  if (roundedBudget <= 1) {
    budgetIcon = '/assets/BudgetBar-Tier1.webp';
    budgetTier = 1;
  } else if (roundedBudget <= 2) {
    budgetIcon = '/assets/BudgetBar-Tier2.webp';
    budgetTier = 2;
  } else if (roundedBudget <= 4) {
    budgetIcon = '/assets/BudgetBar-Tier3.webp';
    budgetTier = 3;
  } else if (roundedBudget <= 8) {
    budgetIcon = '/assets/BudgetBar-Tier4.webp';
    budgetTier = 4;
  } else {
    budgetIcon = '/assets/BudgetBar-Tier5.webp';
    budgetTier = 5;
  }


  // Add icon
  if (budgetIcon) {
    const icon = document.createElement('img');
    icon.src = budgetIcon;
    icon.style.width = '30px';
    icon.style.height = '30px';
    icon.style.verticalAlign = 'middle';
    icon.style.marginRight = '6px';

    // Attach tooltip using BudgetTierLabels
    if (budgetTier && BudgetTierLabels[budgetTier]) {
      attachTooltipToIcon(icon, `Budget Cost: ${BudgetTierLabels[budgetTier]}`);
    }

    budgetPill.appendChild(icon);
  }


  // Singular/plural
  const unitText = (roundedBudget === 1) ? 'Flamingo Unit' : 'Flamingo Units';

  budgetPill.appendChild(
    document.createTextNode(`${roundedBudget} ${unitText}`)
  );

  budgetWrap.appendChild(budgetPill);
  right.appendChild(budgetWrap);
}


    // --- attach left + right divs to li ---
    li.appendChild(left);
    li.appendChild(right);
    results.appendChild(li);
  });

  renderPagination(sorted.length);
}
</script>
</body>
</html>